rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Live scores - public read, function write only
    match /live_scores/{document} {
      allow read: if true;  // Anyone can read live scores
      allow write: if false;  // Only Cloud Functions can write
    }
    
    // Bet tracking - public read/write (for now)
    match /bets/{document=**} {
      allow read, write: if true;
    }
    
    // Basketball bets - public read, temp write for testing
    match /basketball_bets/{document=**} {
      allow read: if true;  // Basketball picks are free, everyone can read
      allow write: if true;  // TEMP: Allow writes for testing (will restrict later to service account only)
    }
    
    // User bookmarks - allow users to manage their own bookmarks
    match /user_bookmarks/{document=**} {
      allow read, write: if true; // Anonymous users can manage their bookmarks
    }
    
    // Perplexity AI cache - Public read/write for GitHub Action
    // Client code cannot write (removed from client), only reads cache
    // GitHub Action needs write access to store analysis for all users
    match /perplexityCache/{document=**} {
      allow read: if true;   // Client can read cached content
      allow write: if true;  // Allow GitHub Action to cache analysis
    }
    
    // API Secrets - public read only (keys stored here)
    match /Secrets/{document=**} {
      allow read: if true;  // Client needs to read API keys
      allow write: if false;  // No writes from client
    }
    
    // User accounts - users can manage their own account
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false; // Users cannot delete their own account documents
    }
    
    // User usage tracking - users can manage their own usage data
    match /user_usage/{usageDoc} {
      // Usage docs are formatted as {userId}_{date}
      // Extract userId from the document ID
      allow read: if request.auth != null && 
                     usageDoc.matches('^' + request.auth.uid + '_.*$');
      allow write: if request.auth != null && 
                      usageDoc.matches('^' + request.auth.uid + '_.*$');
    }
    
    // User daily spins - users can manage their own spin data
    match /user_spins/{spinDoc} {
      // Spin docs are formatted as {userId}_{date}
      // Simplified rule: check if document starts with user's UID
      allow read, write: if request.auth != null && 
                            spinDoc.split('_')[0] == request.auth.uid;
    }
  }
}

